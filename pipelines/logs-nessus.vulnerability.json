{
  "description": "This pipeline will enrich vulnerability scan data found from Nessus.",
  "processors": [
    {
      "append": {
        "if": "ctx.tags == null",
        "field": "tags",
        "value": [
          "vulnerability"
        ],
        "allow_duplicates": false
      }
    },
    {
      "convert": {
        "field": "nessus.cvss3.base_score",
        "type": "float",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "nessus.cvss.base_score",
        "type": "float",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "nessus.cvss.impact_score",
        "type": "float",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "nessus.cvss.temporal_score",
        "type": "float",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "nessus.epss_score",
        "type": "float",
        "ignore_missing": true,
        "if": "ctx.nessus?.epss_score != null",
        "tag": "Convert EPSS score to float"
      }
    },
    {
      "convert": {
        "field": "event.duration",
        "type": "long",
        "ignore_missing": true,
        "if": "ctx.event?.duration != null",
        "tag": "Convert event.duration to long"
      }
    },
    {
      "set": {
        "field": "vulnerability.score.base",
        "value": "{{nessus.cvss3.base_score}}",
        "ignore_empty_value": true,
        "if": "ctx.nessus?.cvss3?.base_score != null",
        "tag": "Set base score using cvss3",
        "description": "Set base score to v3"
      }
    },
    {
      "set": {
        "field": "vulnerability.score.base",
        "value": "{{nessus.cvss4.base_score}}",
        "ignore_empty_value": true,
        "if": "ctx.nessus?.cvss4?.base_score != null",
        "tag": "Set base score using cvss4",
        "description": "Set base score to v4"
      }
    },
    {
      "set": {
        "ignore_failure": true,
        "ignore_empty_value": true,
        "field": "event.ingested",
        "value": "{{_ingest.timestamp}}"
      }
    },
    {
      "script": {
        "source": "double score = ctx.nessus.cvss3.base_score;\r \r def result;\r \r if (score >= 9.0) {\r   result = \"Critical\";\r } else if (score >= 7.0 && score < 9.0) {\r   result = \"High\";\r }else if (score > 4.0 && score < 7.0) {\r   result = \"Medium\";\r }else if (score > 0.0 && score < 4) {\r   result = \"Low\";\r }else if (score == 0.0) {\r   result = \"None\";\r }\r \r ctx.vulnerability.severity = result;",
        "if": "ctx.nessus?.cvss3?.base_score != null",
        "tag": "Set CVSS3 score if needed",
        "description": "Set CVSS3 score if needed"
      }
    },
    {
      "script": {
        "source": "double score = ctx.nessus.cvss4.base_score;\r \r def result;\r \r if (score >= 9.0) {\r   result = \"Critical\";\r } else if (score >= 7.0 && score < 9.0) {\r   result = \"High\";\r }else if (score > 4.0 && score < 7.0) {\r   result = \"Medium\";\r }else if (score > 0.0 && score < 4) {\r   result = \"Low\";\r }else if (score == 0.0) {\r   result = \"None\";\r }\r \r ctx.vulnerability.severity = result;",
        "if": "ctx.nessus?.cvss4?.base_score != null",
        "tag": "Set CVSS4 score if needed",
        "description": "Set CVSS4 score if needed"
      }
    },
    {
      "fingerprint": {
        "fields": [
          "nessus.plugin.id",
          "destination.port",
          "network.transport",
          "vulnerability.id"
        ],
        "target_field": "nessus.vulnerability.custom_hash",
        "ignore_missing": true,
        "if": "ctx.nessus?.vulnerability?.custom_hash == null",
        "tag": "Create unique hash for each vulnerability",
        "description": "Create unique hash for each vulnerability",
        "on_failure": [
          {
            "fingerprint": {
              "fields": [
                "nessus.plugin.id",
                "network.transport",
                "destination.port"
              ],
              "target_field": "nessus.vulnerability.custom_hash",
              "ignore_missing": true,
              "tag": "Create unique hash for each vulnerability without CVE",
              "description": "Create unique hash for each vulnerability without CVE"
            }
          }
        ]
      }
    },
    {
      "set": {
        "field": "host.name",
        "override": false,
        "ignore_empty_value": true,
        "if": "ctx?.host?.name == \"\" || ctx?.host?.name == null",
        "tag": "Set host.name to name_of_host if never defined.",
        "copy_from": "nessus.name_of_host"
      }
    },
    {
      "fingerprint": {
        "fields": [
          "@timestamp",
          "host.name",
          "host.ip",
          "vulnerability.report_id",
          "nessus.plugin.name",
          "nessus.vulnerability.custom_hash",
          "tags",
          "log.origin.file.name",
          "nessus.plugin.output"
        ],
        "target_field": "_id",
        "ignore_missing": true,
        "tag": "Compute unique ID for each vulnerability finding to prevent duplicate data",
        "description": "Compute unique ID for each vulnerability finding to prevent duplicate data"
      }
    }
  ],
  "on_failure": [
    {
      "set": {
        "field": "error.message",
        "value": "Processor \"{{ _ingest.on_failure_processor_type }}\" with tag \"{{ _ingest.on_failure_processor_tag }}\" in pipeline \"{{ _ingest.on_failure_pipeline }}\" failed with message \"{{ _ingest.on_failure_message }}\""
      }
    }
  ]
}