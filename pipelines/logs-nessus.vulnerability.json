{
  "description": "This pipeline will enrich vulnerability scan data found from Nessus.",
  "processors": [
    {
      "append": {
        "if": "ctx.tags == null",
        "field": "tags",
        "value": [
          "vulnerability"
        ],
        "allow_duplicates": false
      }
    },
    {
      "convert": {
        "field": "nessus.cvss3.base_score",
        "type": "float",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "nessus.cvss.base_score",
        "type": "float",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "nessus.cvss.impact_score",
        "type": "float",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "nessus.cvss.temporal_score",
        "type": "float",
        "ignore_missing": true
      }
    },
    {
      "convert": {
        "field": "event.duration",
        "type": "long",
        "ignore_missing": true,
        "if": "ctx.event?.duration != null",
        "tag": "Convert event.duration to long"
      }
    },
    {
      "set": {
        "field": "vulnerability.score.base",
        "value": "{{nessus.cvss3.base_score}}",
        "ignore_empty_value": true,
        "if": "ctx.nessus?.cvss3?.base_score != null",
        "tag": "Set base score",
        "description": "Set base score"
      }
    },
    {
      "script": {
        "source": "double score = ctx.nessus.cvss3.base_score;\r\n\r\ndef result;\r\n\r\nif (score >= 9.0) {\r\n  result = \"Critical\";\r\n} else if (score >= 7.0 && score < 9.0) {\r\n  result = \"High\";\r\n}else if (score > 4.0 && score < 7.0) {\r\n  result = \"Medium\";\r\n}else if (score > 0.0 && score < 4) {\r\n  result = \"Low\";\r\n}else if (score == 0.0) {\r\n  result = \"None\";\r\n}\r\n\r\nctx.vulnerability.severity = result;",
        "if": "ctx.nessus?.cvss3?.base_score != null",
        "tag": "Set CVSS3 score if needed",
        "description": "Set CVSS3 score if needed"
      }
    },
    {
      "fingerprint": {
        "fields": [
          "nessus.plugin.id",
          "destination.port",
          "network.transport",
          "vulnerability.id"
        ],
        "target_field": "nessus.vulnerability.custom_hash",
        "ignore_missing": true,
        "if": "ctx.nessus?.vulnerability?.custom_hash == null",
        "tag": "Create unique hash for each vulnerability",
        "description": "Create unique hash for each vulnerability",
        "on_failure": [
          {
            "fingerprint": {
              "fields": [
                "nessus.plugin.id",
                "network.transport",
                "destination.port"
              ],
              "target_field": "nessus.vulnerability.custom_hash",
              "ignore_missing": true,
              "tag": "Create unique hash for each vulnerability without CVE",
              "description": "Create unique hash for each vulnerability without CVE"
            }
          }
        ]
      }
    },
    {
      "fingerprint": {
        "fields": [
          "@timestamp",
          "host.name",
          "host.ip",
          "vulnerability.report_id",
          "nessus.plugin.name",
          "nessus.vulnerability.custom_hash",
          "tags",
          "log.origin.file.name",
          "nessus.plugin.output"
        ],
        "target_field": "_id",
        "ignore_missing": true,
        "tag": "Compute unique ID for each vulnerability finding to prevent duplicate data",
        "description": "Compute unique ID for each vulnerability finding to prevent duplicate data"
      }
    }
  ],
  "on_failure": [
    {
      "set": {
        "field": "error.message",
        "value": "Processor \"{{ _ingest.on_failure_processor_type }}\" with tag \"{{ _ingest.on_failure_processor_tag }}\" in pipeline \"{{ _ingest.on_failure_pipeline }}\" failed with message \"{{ _ingest.on_failure_message }}\""
      }
    }
  ]
}
